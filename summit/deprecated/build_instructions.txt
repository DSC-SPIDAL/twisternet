CYLON_HOME="$HOME/cylon"
BUILD_PATH="$CYLON_HOME/build"
BUILD_THREADS=8
VENV=$HOME/CYLON

rm -rf $CYLON_HOME/build
export LD_LIBRARY_PATH=$BUILD_PATH/arrow/install/lib64:$BUILD_PATH/lib64:$LD_LIBRARY_PATH

# activate python env
source $VENV/bin/activate

# build c++
mkdir -p $BUILD_PATH && cd $BUILD_PATH
cmake \
-DCMAKE_BUILD_TYPE=Release \
-DCMAKE_INSTALL_PREFIX="$CYLON_HOME/install" \
-DMPI_C_COMPILER=$(which mpicc) \
-DMPI_CXX_COMPILER=$(which mpicxx)  \
-DCYLON_WITH_TEST=1 \
-DCYLON_CUSTOM_MPIRUN=jsrun \
-DCYLON_MPIRUN_PARALLELISM_FLAG="-n" \
-DCYLON_CUSTOM_MPIRUN_PARAMS="-a 1" \
-DPYCYLON_BUILD=1 \
..

make -j $BUILD_THREADS
make install


# build pyarrow

export ARROW_HOME=${BUILD_PATH}/arrow/install

PYARROW_CMAKE_OPTIONS="-DCMAKE_MODULE_PATH=${ARROW_HOME}/lib64/cmake/arrow" PYARROW_WITH_PARQUET=1 \
python setup.py install


# build pycylon

CYLON_PREFIX=${BUILD_PATH} ARROW_PREFIX=${ARROW_HOME} \
python setup.py install
